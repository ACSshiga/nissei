# システムアーキテクチャ

## システム構成図

```
┌─────────────────────────────────────────────────────┐
│                    ユーザー                          │
└──────────────────┬──────────────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────────────┐
│              Next.js Frontend                        │
│              (Port: 3000)                           │
│  - TypeScript + React                               │
│  - Tailwind CSS                                     │
│  - SWR (データフェッチング)                          │
└──────────────────┬──────────────────────────────────┘
                   │ HTTP/REST
                   ▼
┌─────────────────────────────────────────────────────┐
│              FastAPI Backend                         │
│              (Port: 8000)                           │
│  - Python 3.11+                                     │
│  - Pydantic (バリデーション)                         │
│  - JWT認証                                          │
└──────────────────┬──────────────────────────────────┘
                   │
         ┌─────────┴─────────┐
         │                   │
         ▼                   ▼
┌──────────────────┐  ┌──────────────────┐
│    Supabase      │  │      MinIO       │
│   PostgreSQL     │  │  (File Storage)  │
│  (Port: 5432)    │  │  (Port: 9000)    │
└──────────────────┘  └──────────────────┘
```

## 技術スタック

### フロントエンド
- **フレームワーク**: Next.js 14 (App Router)
- **言語**: TypeScript
- **スタイリング**: Tailwind CSS
- **状態管理**: React Hooks + Context API
- **データフェッチング**: SWR
- **フォーム**: React Hook Form
- **バリデーション**: Zod

### バックエンド
- **フレームワーク**: FastAPI
- **言語**: Python 3.11+
- **ORM**: SQLAlchemy
- **マイグレーション**: Alembic
- **バリデーション**: Pydantic
- **認証**: JWT (JSON Web Tokens)

### データベース
- **メインDB**: Supabase (PostgreSQL)
- **ファイルストレージ**: MinIO (S3互換)

### インフラ
- **コンテナ**: Docker + Docker Compose
- **CI/CD**: GitHub Actions
- **ホスティング**: TBD

## ディレクトリ構造

```
nissei/
├── frontend/              # Next.jsフロントエンド
│   ├── src/
│   │   ├── app/          # App Routerページ
│   │   ├── components/   # 再利用可能コンポーネント
│   │   ├── lib/          # ユーティリティ・API
│   │   ├── hooks/        # カスタムフック
│   │   └── types/        # TypeScript型定義
│   ├── public/           # 静的ファイル
│   └── package.json
│
├── backend/              # FastAPIバックエンド
│   ├── app/
│   │   ├── models/      # SQLAlchemyモデル
│   │   ├── schemas/     # Pydanticスキーマ
│   │   ├── routers/     # APIルーター
│   │   ├── services/    # ビジネスロジック
│   │   └── utils/       # ユーティリティ
│   ├── alembic/         # DBマイグレーション
│   └── requirements.txt
│
├── docs/                # ドキュメント（プロジェクト固有）
├── ai-rules/            # AI用ルール（汎用）
├── CLAUDE.md            # Claude Code設定
├── README.md            # プロジェクト概要
└── docker-compose.yml   # Docker設定
```

## データフロー

### 認証フロー

```
1. ユーザーがログイン情報を入力
   ↓
2. フロントエンド → バックエンド: POST /api/auth/login
   ↓
3. バックエンドが認証情報を検証
   ↓
4. JWTトークンを生成
   ↓
5. フロントエンドにトークンを返却
   ↓
6. フロントエンドがトークンをLocalStorageに保存
   ↓
7. 以降のリクエストにトークンを含める (Authorization: Bearer <token>)
```

### データ取得フロー

```
1. フロントエンドがSWRでデータをリクエスト
   ↓
2. API呼び出し (例: GET /api/projects)
   ↓
3. バックエンドがJWTトークンを検証
   ↓
4. データベースからデータ取得
   ↓
5. Pydanticスキーマでレスポンスを整形
   ↓
6. フロントエンドにJSONを返却
   ↓
7. SWRがキャッシュして表示
```

### ファイルアップロードフロー

```
1. ユーザーがファイルを選択
   ↓
2. フロントエンド → バックエンド: POST /api/upload
   ↓
3. バックエンドがファイルを検証
   ↓
4. MinIOにファイルをアップロード
   ↓
5. ファイルURLをデータベースに保存
   ↓
6. フロントエンドにURLを返却
```

## セキュリティ

### 認証・認可
- JWTトークンベース認証
- アクセストークン + リフレッシュトークン
- ロールベースアクセス制御（RBAC）

### データ保護
- パスワードハッシュ化（bcrypt）
- HTTPS通信（本番環境）
- CORS設定
- SQL Injection対策（ORMパラメータ化クエリ）

### ファイルセキュリティ
- ファイルタイプ検証
- ファイルサイズ制限
- 署名付きURL（MinIO Pre-signed URLs）

## パフォーマンス最適化

### フロントエンド
- SWRによるキャッシング
- 画像最適化（Next.js Image）
- コード分割（Dynamic Import）
- Server Components活用

### バックエンド
- データベースインデックス
- N+1クエリ回避
- ページネーション実装
- レスポンス圧縮

### データベース
- 適切なインデックス設定
- クエリ最適化
- コネクションプーリング

## スケーラビリティ

### 水平スケーリング
- ステートレスAPI設計
- セッションストアの外部化（Redis等）
- ロードバランサー対応

### 垂直スケーリング
- データベースリソース増強
- アプリケーションサーバーリソース増強

## 監視・ログ

### ロギング
- アプリケーションログ（レベル別）
- アクセスログ
- エラーログ

### メトリクス
- レスポンスタイム
- エラー率
- リクエスト数

### アラート
- Discord Webhook（GitHub連携）
- エラー通知

## デプロイメント

### 開発環境
- Docker Compose
- ホットリロード有効

### 本番環境（予定）
- コンテナオーケストレーション
- CI/CDパイプライン
- ブルーグリーンデプロイメント

## 関連ドキュメント

- [環境構築](./SETUP.md)
- [API仕様](./API.md)
- [データベース設計](./DATABASE.md)
- [要件定義](./requirements-definition.md)
