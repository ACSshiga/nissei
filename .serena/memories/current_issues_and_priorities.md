# 現在のIssue・優先度・ブロッカー

**最終更新**: 2025-10-02（セッション2）

## ✅ 完了した作業（このセッション）

### PR #34: ドキュメント構造を3層に再編成

**マージ完了** (main へ squash merge)

**内容**:
1. ✅ Serenaメモリ追加（8個）- AI用詳細仕様
2. ✅ ai-rules/ を2層構造に分離（common/ + nissei/）
3. ✅ docs/ を人間用に簡素化（-77~88%削減）
4. ✅ reference/ フォルダ作成（参考資料集約）
5. ✅ CLAUDE.md 更新（2層構造対応）

**メリット**:
- AI用・人間用・参考資料を明確に分離
- Serenaメモリでセッション間のコンテキスト維持
- ai-rules/common/ は他プロジェクトで再利用可能

**フォローアップIssue**: #35（ドキュメント構造の残タスク）

---

## 🚨 最優先課題（Critical）

### 1. 仕様の齟齬を解消する（**ブロッカー**）

**状況**:
- 要件定義書: シンプルな案件管理
- 実装: 製造業・機械設計向けの専門的な仕様
- **新仕様**（前回セッションで確定）: 製造業特化の12テーブル構成が**正しい**

**未確認事項（5項目）**:
1. 案件管理画面に必要な項目（管理No、機番、機種シリーズ、世代、トン数、仕様タグ、進捗マスタ、作業区分マスタ、問い合わせマスタ）は必要か？
2. PDFの取り込み方法（自動読み取り/手動入力）
3. 担当者管理（1案件に複数の担当者をアサイン可能？）
4. 進捗管理の仕様（マスタで管理？カスタマイズ可能？）
5. 工数入力の粒度（日単位/時間単位、開始時刻・終了時刻は必要？）

**次のアクション**: 
- ユーザーに上記5項目を確認してから次のフェーズに進む
- **または**: 現在の実装（製造業特化12テーブル）が正しいと仮定して、Phase 1残り機能を実装

---

## ⚠️ ブロックされている課題

### Supabaseスキーマキャッシュ問題（E2Eテスト中断中）

**状況**:
- バックエンドのSupabaseクライアントが `work_logs` テーブルを認識しない
- エラー: `"Could not find the table 'public.work_logs' in the schema cache"`
- Supabase MCP（別接続）では `work_logs` テーブルを正しく認識

**試した解決策**:
- ✅ マイグレーション適用
- ✅ バックエンドコンテナ再起動（複数回）
- ✅ 全コンテナ再起動
- ❌ スキーマキャッシュのリフレッシュ（Supabase側の操作が必要）

**解決方法**:
- Option A: Supabase Studioでスキーマをリフレッシュ（推奨）
- Option B: E2Eテストをスキップして、コードレベル検証に切り替え

**影響**:
- 工数入力画面のE2Eテストが中断中
- 現時点で完了した作業:
  - ✅ データベースリセット完了
  - ✅ ログイン機能テスト成功
  - ✅ UI経由でのプロジェクト作成成功

---

## 📋 進行中のタスク

### Phase 1実装状況（~80%完了）

| 項目 | 状態 | 備考 |
|-----|------|------|
| 認証システム | ✅ 100% | Supabase Auth統合完了 |
| ユーザー管理 | ✅ 100% | 管理者パネル実装済み |
| マスタ管理 | ✅ 100% | 6種類すべて完了 |
| 案件管理（CRUD） | ✅ 80% | 基本機能完了、詳細機能は仕様確認待ち |
| 工数入力 | ✅ 90% | スプレッドシート風UI実装済み |
| 請求書生成 | ❌ 0% | 未着手 |
| 資料管理 | ❌ 0% | 未着手 |
| 注意点管理 | ❌ 0% | 未着手 |

---

## 🎯 次のステップ（優先度順）

### 優先度: High（最優先）

#### Option A: 仕様確認後に実装継続（推奨）

1. **仕様確認ミーティング**
   - 未確認事項5項目の確認
   - 要件定義書の更新 or 実装の修正決定

2. **Supabaseスキーマキャッシュ問題の解決**
   - Supabase Studioでスキーマをリフレッシュ
   - または、コードレベル検証に切り替え

3. **Phase 1の残り機能実装**
   - 請求書生成機能（0%）
   - 資料管理機能（0%）
   - 注意点管理機能（0%）

#### Option B: 現在の実装を正しいと仮定して進める

製造業特化12テーブル構成が正しいと仮定し、残り機能を実装:

1. **請求書生成機能**
   - invoices, invoice_itemsテーブル作成
   - APIエンドポイント実装（preview, close, export）
   - CSV生成ロジック
   - フロントエンドUI実装

2. **資料管理機能**
   - materialsテーブル作成
   - Supabase Storage設定
   - スコープベース検索ロジック
   - フロントエンドUI実装

3. **注意点管理機能**
   - chuitenテーブル作成
   - 案件別注意点API実装
   - マスタ展開ロジック
   - フロントエンドUI実装

---

## 📌 記録事項

### 最近のPR・マージ履歴

- **#34: ドキュメント構造を3層に再編成** ✅ マージ完了（2025-10-02）
  - Serenaメモリ追加、ai-rules/ 2層構造化、docs/ 簡素化、reference/ 作成
- #33: usersテーブルのpasswordカラム名をhashed_passwordに統一
- #32: 工数入力APIにstart_time/end_timeフィールドを追加
- #31: Supabaseマイグレーションでwork_logsテーブルに必須カラムを追加
- #21: 工数入力画面をスプレッドシート風UIに全面改修

### 現在のIssue

- **#35: ドキュメント構造の残タスク**（PR #34フォローアップ）
  - Major: database_api_specifications.mdの位置づけ、CLAUDE.mdとREADMEの重複
  - Minor: docs/README.mdディレクトリ構造、リンク形式統一、ファイル名統一、絵文字ルール

### git status（セッション終了時）

```
Current branch: main
On branch main
Your branch is up to date with 'origin/main'.

nothing to commit, working tree clean
```

---

## 💡 メモ

### Serena MCPの活用状況

- ✅ プロジェクト有効化完了
- ✅ メモリ読み込み完了（current_issues_and_priorities.md）
- ✅ 8個のメモリファイルがmainブランチにマージ済み
- ✅ DOCUMENTATION_GUIDE.mdでメモリ管理フローを定義

### 次回セッション開始時のフロー

1. `mcp__serena__activate_project` (project: "nissei")
2. `mcp__serena__read_memory` ("current_issues_and_priorities.md")
3. 仕様確認状況を確認（Option A or Option B）
4. Phase 1残り機能の実装開始

---

## 🔧 技術的負債

### 1. テストカバレッジ不足
- バックエンド: 単体テスト未実装
- フロントエンド: 単体テスト未実装
- E2E: 一部のみ実装（Supabaseスキーマキャッシュ問題で中断中）

### 2. エラーハンドリング不足
- Supabase APIエラーハンドリング（一部修正済み）
- フロントエンド通信エラーの詳細表示

### 3. バリデーション不足
- 15分刻みバリデーションがフロントエンドのみ
- バックエンド側のバリデーション強化が必要

### 4. UI/UX改善
- `alert()`の使用（トースト通知推奨）
- プロジェクト選択肢がIDのみ表示（プロジェクト名表示推奨）
- ローディング状態表示の統一
