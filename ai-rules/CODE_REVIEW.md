# コードレビューガイドライン

このドキュメントでは、コードレビューの観点とチェックリストを提供します。

**レビュープロセスの詳細**: [PR_MERGE_PROCESS.md](./PR_MERGE_PROCESS.md) を参照してください。

---

## レビューの実施（必須）

### タイミング
⚠️ **PR作成直後に必ず実施**

### レビュー方法
詳細は [PR_MERGE_PROCESS.md](./PR_MERGE_PROCESS.md) の「Codex MCP によるレビュー」セクションを参照してください。

---

## レビュー観点

### セキュリティ
- [ ] 認証・認可が適切に実装されている
- [ ] 機密情報がハードコードされていない
- [ ] 入力値の検証が行われている
- [ ] SQLインジェクション対策がされている
- [ ] XSS（クロスサイトスクリプティング）対策がされている
- [ ] CSRF対策がされている（APIトークン認証の場合）

### パフォーマンス
- [ ] N+1クエリが発生していない
- [ ] 不要なデータ取得をしていない
- [ ] キャッシュが適切に利用されている
- [ ] 大量データ処理でメモリリークがない
- [ ] データベースインデックスが適切に設定されている

### コード品質
- [ ] [命名規則](./NAMING_CONVENTIONS.md) に準拠している
- [ ] 適切な関数・クラス分割がされている
- [ ] 重複コードがない（DRY原則）
- [ ] 適切なエラーハンドリングがされている
- [ ] コメントが必要な箇所に記載されている
- [ ] マジックナンバーが定数化されている
- [ ] 複雑な条件式が分かりやすく記述されている

### テスト
- [ ] [E2Eテスト](./TESTING.md) が実装されている
- [ ] 正常系・異常系のテストがある
- [ ] エッジケースが考慮されている
- [ ] テストカバレッジが十分である
- [ ] テストが独立している（実行順序に依存しない）

### ドキュメント
- [ ] README/ドキュメントが更新されている
- [ ] APIドキュメントが更新されている（API変更時）
- [ ] 複雑なロジックにコメントがある
- [ ] 環境変数の追加時に `.env.example` が更新されている
- [ ] データベーススキーマ変更時にマイグレーション手順が文書化されている

---

## レビューコメントの対応

### 優先度の判断

- **Critical（必須対応）** 🔴: セキュリティ、バグ、データ破損のリスク
- **Major（推奨対応）** 🟠: パフォーマンス、保守性の大幅改善
- **Minor（検討）** 🟡: より良い実装方法の提案

### 返信のガイドライン

1. **対応した場合**
   ```
   ご指摘ありがとうございます。
   [修正内容の説明]
   コミット: [コミットハッシュ]
   ```

2. **対応しない場合**
   ```
   ご提案ありがとうございます。
   [対応しない理由]
   今回は[代替案]で進めさせていただきます。
   ```

3. **質問がある場合**
   ```
   ご指摘の件について確認させてください。
   [具体的な質問]
   ```

---

## セルフレビュー（レビュー前）

PR作成前に自分でチェック：

- [ ] 変更内容を再確認
- [ ] 不要なコメントやデバッグコードを削除
- [ ] `console.log()` や `print()` を削除
- [ ] フォーマットが統一されている
- [ ] 不要なファイルが含まれていない
- [ ] `.gitignore` が適切に設定されている
- [ ] コミットメッセージが [COMMIT_GUIDELINES.md](./COMMIT_GUIDELINES.md) に準拠している

---

## PR更新後の必須アクション

⚠️ **重要**: PRを更新（コミット・push）するたびに、必ず以下を実施：

### 1. 再レビュー依頼
Codex MCPで再度レビュー依頼を実施

### 2. 修正内容の確認
```markdown
## ✅ レビュー指摘事項を修正しました

### 修正内容
- 修正1: 具体的な内容
- 修正2: 具体的な内容

修正コミット: <commit-hash>
```

### 3. レビュー結果を確認
- Codex MCPが最新コミットを確認
- 新たな指摘があれば再度修正

### 4. すべての指摘が解決されるまで繰り返し
- 「修正 → push → Codex MCPレビュー」を繰り返す
- すべての指摘が解決されたらマージ可能

---

## レビュー後のアクション

### 承認された場合
1. **マージ前の最終確認**
   - `mcp__github__get_pull_request` でPR状態を確認
   - `mergeable: true` であることを確認

2. **mainブランチへマージ**
   - `mcp__github__merge_pull_request` を使用
   - merge_method: `squash`（推奨）

3. **レビュー履歴を記録**
   - `docs/PR_REVIEW_HISTORY.md` に記録

4. **ブランチ削除（任意）**
   ```bash
   git branch -d <ブランチ名>
   git push origin --delete <ブランチ名>
   ```

### 修正が必要な場合
1. 指摘事項を修正
2. コミット・プッシュ
3. **必ず** Codex MCP で再レビュー依頼

### 議論が必要な場合
1. PRコメントで議論
2. 必要に応じてチームメンバーに相談
3. 方針決定後に修正・マージ

---

## 注意事項

- **mainブランチへのマージ前には必ずレビューを実施**
- レビュー指摘を無視してマージしない
- 重大な指摘は必ず対応してからマージ
- 軽微な指摘でも次回以降は改善する
- **Critical問題が存在する場合は絶対にマージしない**

---

## 関連ドキュメント

- [PR_MERGE_PROCESS.md](./PR_MERGE_PROCESS.md): PRマージプロセスの詳細
- [PR_GUIDELINES.md](./PR_GUIDELINES.md): PR作成ガイドライン
- [TESTING.md](./TESTING.md): テストガイドライン
- [NAMING_CONVENTIONS.md](./NAMING_CONVENTIONS.md): 命名規則
- [COMMIT_GUIDELINES.md](./COMMIT_GUIDELINES.md): コミットメッセージガイドライン
