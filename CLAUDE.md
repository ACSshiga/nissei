# Claude Code Configuration

## YOU MUST:

- 全ての TODO 完了またはユーザー のアクションが必要な際は最後に一度だけ `afplay /System/Library/Sounds/Sosumi.aiff` コマンドを実行して通知する
- 回答は日本語で行ってください
- TODO には必ずブランチ作成・実装内容のテスト・コミット・push・PR 作成（まだ作成されていない場合）が含まれるべきです

## issue 作成時の注意事項

issue 作成時の注意事項を ai-rules/ISSUE_GUIDELINES.md にまとめています
issue 作成時は必ず確認して必ずこの内容に従って issue 作成を行ってください。

## Repository 設定

- **リポジトリ名**: nissei
- **MCP GitHub API**: 常に `nissei` リポジトリを使用
- **Git remote**: origin

## アプリケーションポート設定

以下のポートで各サービスが動作します：

### 開発環境（Docker Compose）

- 以下のポート番号を勝手に変更することは絶対にあってはなりません。
- **フロントエンド**: `http://localhost:3000` (ポート: 3000)
- **バックエンド API**: `http://localhost:8000` (ポート: 8000)

## 関数・エンドポイント作成時の注意事項

- 命名規則などを@ai-rules/API_FUNCTION_NAMING.md にまとめています
- 関数やエンドポイントの作成時には必ず確認し、内容に従って実装を行ってください。

## 修正機能追加の際の作業開始時・終了時に必ず実施すること。必ず毎回全て todo に含めてください。

- 以下の操作は作業開始時に必ず行ってください
  - **作業開始時**: 必ず専用ブランチを作成する（feat-<機能名>、fix-<修正内容>等）
  - **main ブランチでの直接作業は絶対禁止**: いかなる変更も main ブランチに直接コミットしない
- 以下を必ず作業終了時に実行してください。
  1. 作業内容をコミット
  2. リモートブランチに push (`git push -u origin <ブランチ名>`)
  3. PR 作成 (MCP で PR 作成)
  4. **mainブランチへのマージ前には必ずCodexレビューを実施**
     - PRに `@codex review` とコメントしてCodexのレビューを依頼
     - Codexの指摘事項を確認し、必要に応じて修正
     - レビュー完了後にマージを実施
     - 💬 **Discord通知**: PRコメント・レビューは自動的にDiscordへ通知されます
  - @ai-rules/COMMIT_AND_PR_GUIDELINES.md にガイドラインを記述しています。上記の作業時には必ず確認して必ず内容に従って作業を行ってください。

## 修正の際の注意点

- 修正を行う際には必ず以下のことに順守してください
  - 該当修正によって他の処理に問題がないか慎重に確認を行って作業を行ってください。
  - 他の動作に関しても修正が必要な場合は既存の期待値の動作が正常に起動するように修正してください。

## コミット前に確認すること（必ず実施）

- コミット前には必ず動作確認を行って動作が問題ないかを確認してください
  - 動作確認中にエラーが発見された際はタスクを更新してください
  - コミットする際はエラーがない状態で行ってください

## 開発時の注意点

- Tailwind CSS を優先して使用し、重複スタイルは避けること
- バックエンド API は FastAPI で定義し、リクエスト/レスポンススキーマには Pydantic モデルを使うこと
- .env ファイル内のキーは UPPER_SNAKE_CASE で記述し、値にクォートは付けないこと

## ファイル作成時の注意点（ファイル作成時必ず確認）

- ファイル作成時に、そのファイルが Github に挙げられるべきではないと判断した場合には、必ず.gitignore に指定してください。

## 注意：

すでにポートが使用されている場合（例: 3000 番や 8000 番など）、起動に失敗することがあります。
その場合は該当ポートを使用している場合は、そのポートを使用してください。
別の PJ にて使用されている場合は、そのプロセスを特定し、kill することで使用してください。

# 例: ポート 8000 が使用中の場合

lsof -i :8000
kill -9 <PID>

## 動作確認・テスト時の必須確認事項（コミット前に必ず実施されるべきです）

- テスト・動作確認の際は playwright の MCP ツールを使用して動作確認を行ってください。
- テスト・動作確認は修正を行って際は必ず行ってください。
- E2E テストとしてユーザ目線での動作が問題ないかしっかりと確認してください。
  開発・テスト時は以下のユーザー情報を使用してください

メールアドレス: qa+shared@example.com
パスワード: SharedDev!2345
ユーザー名: qa_shared
ユーザー ID（固定 UUID v4 想定）: 00000000-0000-4000-8000-000000000000TEST_EMAIL=qa+nissei@example.com

### 🔄 Claude Code と Codex CLI の使い分けルール

1. **通常の実装タスク（新規機能、軽微な修正、リファクタなど）**  
   → Claude Code を利用する

2. **バグ修正が 3 回以上失敗した場合**  
   → Codex CLI (MCP) に切り替えて、詳細な解析や原因追跡を依頼する

3. **アーキテクチャ設計やシステム全体の相談**  
   → Codex CLI (MCP) に相談する（Claude Code より深い推論能力を活用）

## 🔗 参考ドキュメント

Claude Code / Codex CLI と併用する MCP サーバーの使い方については  
[ai-rules/MCP_GUIDE.md](./ai-rules/MCP_GUIDE.md) に詳細をまとめています。

- 各 MCP サーバーの用途
- 代表的なプロンプト例
- 注意点（セキュリティ・ポート・環境変数など）
- Issue / PR 作成フローとの関連

開発時には必ず確認してください。

### 🧠 Context7（コンテキスト 7） 利用ルール

以下の状況で Context7 を活用し、応答の精度と整合性を高めることを推奨します：

1. **応答に最新のライブラリ仕様 / ドキュメントを正確に反映させたい場合**  
   → `use context7` プロンプト指定を行い、最新のソースから情報を取得する

2. **長文や複雑な依存関係をもつ解析 / 要約 / コード生成**  
   → 通常の Claude Code では文脈が不足しやすいため、Context7 を併用して文脈の広さを補う

3. **Codex CLI を使う際にも併用可**  
   → Codex CLI で処理を担当するが、文脈補強に Context7 を組み込むよう指示可能

4. **プロンプト記述例**

   - `use context7 — Next.js で認証機能を実装するガイドを教えて`
   - `use context7 — このライブラリの最新ドキュメントを参照して関数呼び出し例を示して`

5. **制約・注意点**
   - 機密情報の取り扱いには注意。必要に応じてセキュリティ確認を実施する
   - Context7 を使っても、必ず生成結果の妥当性チェックを行うこと
